// ==UserScript==
// @name         CantonLoop è‡ªåŠ¨è½¬è´¦åŠ©æ‰‹
// @namespace    http://tampermonkey.net/
// @version      1.0
// @match        https://cantonloop.com/*
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_addStyle
// ==/UserScript==

(function() {
    'use strict';

    // --- ç”¨æˆ·é…ç½®åŒºåŸŸ ---
    const CONFIG = {
        targetAddress: "cantonwallet-tootoo::122...288", // æ¥æ”¶è½¬è´¦çš„ç›®æ ‡åœ°å€
        transferAmount: "0.000001",                      // æ¯æ¬¡è½¬è´¦é‡‘é¢
        password: "YOUR_PASSWORD_HERE",                  // äº¤æ˜“å¯†ç 
        hotkeyStart: "s",                                // Alt+s å¯åœ
        waitCheckInterval: 5 * 60 * 1000,                // ä½™é¢ä¸è¶³æŒ‚æœºåˆ·æ–°é—´éš”
        actionDelay: 1500                                // åŠ¨ä½œå»¶è¿Ÿ
    };

    // --- çŠ¶æ€ç®¡ç† ---
    const STATE = { STOPPED: 0, RUNNING: 1, WAITING_FOR_BALANCE: 2 };
    let currentStatus = GM_getValue('scriptStatus', STATE.STOPPED);
    let nextRefreshTime = GM_getValue('nextRefreshTime', 0);

    // --- UI ---
    const uiBox = document.createElement('div');
    Object.assign(uiBox.style, {
        position: 'fixed', bottom: '20px', right: '20px', padding: '10px',
        background: 'rgba(0,0,0,0.85)', color: '#fff', zIndex: '999999',
        borderRadius: '8px', fontSize: '13px', fontFamily: 'monospace',
        border: '1px solid #666'
    });
    document.body.appendChild(uiBox);

    function updateUI(text) {
        const statusIcon = currentStatus === STATE.RUNNING ? "ğŸŸ¢" : (currentStatus === STATE.WAITING_FOR_BALANCE ? "â³" : "ğŸ”´");
        uiBox.innerHTML = `<div><strong>CantonBot ${statusIcon}</strong></div>
                           <div style="margin-top:5px;">${text}</div>`;
    }

    function setNativeValue(element, value) {
        const lastValue = element.value;
        element.value = value;
        const tracker = element._valueTracker;
        if (tracker) {
            tracker.setValue(lastValue);
        }
        element.dispatchEvent(new Event('input', { bubbles: true }));
    }

    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

    // --- åŠŸèƒ½æ¨¡å— ---

    // 1. å¯†ç å¤„ç†
    async function handlePasswordModal() {
        const passwordInput = document.querySelector('input[type="password"]');
        
        // æŸ¥æ‰¾æ‰€æœ‰å¯è§çš„ Continue æŒ‰é’®
        const continueBtns = Array.from(document.querySelectorAll('button'))
            .filter(b => b.innerText.includes('Continue') && b.offsetParent !== null);

        if (passwordInput && continueBtns.length > 0) {
            if (passwordInput.offsetParent !== null) {
                
                // å¦‚æœè¿˜æ²¡è¾“å…¥å¯†ç ï¼Œæ‰è¾“å…¥
                if (passwordInput.value !== CONFIG.password) {
                    updateUI("è¾“å…¥å¯†ç ...");
                    setNativeValue(passwordInput, CONFIG.password);
                    await sleep(500); // ç»™ä¸€ç‚¹æ—¶é—´è®©Reactååº”
                }

                const targetBtn = continueBtns[continueBtns.length - 1];
                
                if (!targetBtn.disabled) {
                    updateUI("ç‚¹å‡» Continue...");
                    targetBtn.click();
                    await sleep(2000); // ç­‰å¾…å¤„ç†
                    return true;
                } else {
                    updateUI("å°è¯•æ¿€æ´»æŒ‰é’®...");
                    passwordInput.dispatchEvent(new Event('input', { bubbles: true }));
                    await sleep(500);
                }
            }
        }
        return false;
    }

    // 2. å¾…ç¡®è®¤äº¤æ˜“
    async function processPendingTransactions() {
        const pendingItems = document.querySelectorAll('div._pendingTransferItem_1kieh_31');
        if (pendingItems.length > 0) {
            const acceptBtn = Array.from(pendingItems[0].querySelectorAll('button')).find(b => b.innerText.trim() === 'Accept');
            if (acceptBtn) {
                updateUI("ç‚¹å‡» Accept...");
                acceptBtn.click();
                await sleep(1500);
                return true;
            }
        }
        return false;
    }

    // 3. è½¬è´¦æµç¨‹ (ä¼˜å…ˆçº§é€»è¾‘ï¼šConfirm > Address > Amount)
    async function processSendingFlow() {
        
        // [ä¼˜å…ˆçº§ 1] æœ€ç»ˆç¡®è®¤ (Confirm)
        const confirmBtn = document.getElementById('confirmSendButton') || 
                           Array.from(document.querySelectorAll('button')).find(b => b.innerText.trim() === 'Confirm');
        
        if (confirmBtn) {
            updateUI("æ­¥éª¤: ç‚¹å‡» Confirm...");
            confirmBtn.click();
            await sleep(2000);
            return;
        }

        // [ä¼˜å…ˆçº§ 2] è¾“å…¥åœ°å€
        const recipientInput = document.querySelector('input#recipient');
        if (recipientInput) {
            updateUI("æ­¥éª¤: è¾“å…¥åœ°å€...");
            setNativeValue(recipientInput, CONFIG.targetAddress);
            await sleep(500);
            const nextBtn = Array.from(document.querySelectorAll('button')).find(b => b.innerText.includes('Next'));
            if (nextBtn) { nextBtn.click(); await sleep(CONFIG.actionDelay); return; }
        }

        // [ä¼˜å…ˆçº§ 3] è¾“å…¥é‡‘é¢
        const amountInput = document.querySelector('input#value');
        if (amountInput) {
            // --- å¸ç§çº é”™ Start ---
            const tokenSelector = document.querySelector('button._wrapper_1og66_9._transparent_1og66_16');
            if (tokenSelector) {
                const symbolSpan = tokenSelector.querySelector('span._symbol_1og66_67');
                if (symbolSpan && symbolSpan.innerText.trim() !== 'CBTC') {
                    updateUI("çº é”™: åˆ‡æ¢å› CBTC...");
                    tokenSelector.click();
                    await sleep(1000);
                    // åœ¨å¼¹çª—åˆ—è¡¨é‡Œæ‰¾ CBTC
                    const modal = document.querySelector('div._modalContent_16jqu_23'); // è¿™é‡Œçš„ç±»åå¦‚æœå˜äº†ä¹Ÿæ²¡äº‹ï¼Œä¸‹é¢æ˜¯å…¨å±€æ‰¾
                    const allTokenBtns = document.querySelectorAll('button._wrapper_1og66_9'); 
                    for (let btn of allTokenBtns) {
                         // å¿…é¡»æ˜¯å¼¹çª—é‡Œçš„ï¼ˆæœ‰çˆ¶çº§ modal æˆ–åªæ˜¯ç®€å•çš„å¯è§æ€§åˆ¤æ–­ï¼‰
                         if (btn.offsetParent !== null && btn.querySelector('span._symbol_1og66_67')?.innerText.trim() === 'CBTC') {
                             btn.click();
                             await sleep(1500);
                             break;
                         }
                    }
                    return;
                }
            }
            // --- å¸ç§çº é”™ End ---

            // ä½™é¢æ£€æŸ¥
            const availableBtn = document.querySelector('button._availableValue_1u2j6_116');
            if (availableBtn) {
                 const availableText = availableBtn.innerText.replace(/[^0-9.]/g, '');
                 if (parseFloat(availableText) < parseFloat(CONFIG.transferAmount)) {
                     updateUI("ä½™é¢ä¸è¶³ï¼Œè¿”å›æŒ‚æœº...");
                     startWaiting();
                     window.location.href = "https://cantonloop.com/dashboard";
                     return;
                 }
            }

            updateUI("æ­¥éª¤: è¾“å…¥é‡‘é¢...");
            setNativeValue(amountInput, CONFIG.transferAmount);
            await sleep(800);
            
            const continueBtns = Array.from(document.querySelectorAll('button')).filter(b => b.innerText.includes('Continue') && !b.disabled);
            if (continueBtns.length > 0) {
                // ç‚¹å‡»é¡µé¢ä¸Šæœ€åä¸€ä¸ªå¯è§çš„ Continue
                continueBtns[continueBtns.length - 1].click();
                await sleep(CONFIG.actionDelay);
                return;
            }
        }
    }

    // 4. è¾…åŠ©å‡½æ•°ï¼šæ‰¾ CBTC æŒ‰é’®
    function findCBTCButton() {
        const buttons = document.querySelectorAll('button._wrapper_1og66_9');
        for (let btn of buttons) {
            if (btn.classList.contains('_transparent_1og66_16')) continue; 
            const symbol = btn.querySelector('span._symbol_1og66_67');
            if (symbol && symbol.innerText.trim() === 'CBTC') {
                return btn;
            }
        }
        return null;
    }

    function startWaiting() {
        currentStatus = STATE.WAITING_FOR_BALANCE;
        nextRefreshTime = Date.now() + CONFIG.waitCheckInterval;
        GM_setValue('scriptStatus', currentStatus);
        GM_setValue('nextRefreshTime', nextRefreshTime);
    }

    // --- ä¸»å¾ªç¯ ---
    async function mainLoop() {
        if (currentStatus === STATE.STOPPED) {
            updateUI("å·²åœæ­¢ (Alt+s å¯åŠ¨)");
            return;
        }

        if (currentStatus === STATE.WAITING_FOR_BALANCE) {
            const remaining = Math.ceil((nextRefreshTime - Date.now()) / 1000);
            if (remaining <= 0) {
                currentStatus = STATE.RUNNING;
                GM_setValue('scriptStatus', STATE.RUNNING);
                window.location.reload();
            } else {
                updateUI(`ä½™é¢ä¸è¶³ï¼ŒæŒ‚æœº: ${remaining}s`);
            }
            return;
        }

        // 1. å…¨å±€æ£€æµ‹å¯†ç æ¡† (ä¼˜å…ˆçº§æœ€é«˜)
        if (await handlePasswordModal()) return;

        // 2. å…¨å±€æ£€æµ‹ Confirm æŒ‰é’® (ä¼˜å…ˆçº§æ¬¡é«˜ï¼Œé˜²æ­¢å¡æ­»)
        if (document.getElementById('confirmSendButton')) {
            await processSendingFlow();
            return;
        }

        // 3. å¤„ç† Dashboard å¾…ç¡®è®¤åˆ—è¡¨
        const pendingList = document.querySelector('div._listWrapper_1kieh_17');
        if (pendingList) {
            if (await processPendingTransactions()) return;
            // å¦‚æœåˆ—è¡¨è¿˜åœ¨ä½†æ²¡Acceptäº†ï¼Œå¯èƒ½æ˜¯çŠ¶æ€æ²¡åˆ·æ–°ï¼Œé‡è½½
            if (document.querySelectorAll('div._pendingTransferItem_1kieh_31').length === 0) {
                window.location.reload();
                return;
            }
        }

        // è·¯å¾„åˆ¤æ–­
        const isDashboard = window.location.href.includes('/dashboard') && !document.querySelector('input#recipient');
        const isSendPage = document.querySelector('input#recipient') || document.querySelector('input#value');
        
        // 4. Dashboard -> è¿›è¯¦æƒ…é¡µ
        if (isDashboard) {
            const cbtcBtn = findCBTCButton();
            if (cbtcBtn) {
                // ç®€å•ä½™é¢é¢„æ£€
                const amountSpan = cbtcBtn.querySelector('span._amount_1og66_77');
                if (amountSpan) {
                    const bal = parseFloat(amountSpan.innerText.replace(/[^0-9.]/g, ''));
                    if (bal < parseFloat(CONFIG.transferAmount)) {
                        updateUI(`é¦–é¡µä½™é¢ä¸è¶³(${bal})ï¼ŒæŒ‚æœº...`);
                        startWaiting();
                        return;
                    }
                }
                updateUI("ç‚¹å‡» CBTC...");
                cbtcBtn.click();
                await sleep(2000);
                return;
            }
        }

        // 5. è¯¦æƒ…é¡µ -> ç‚¹å‡» Send
        const sendBtn = Array.from(document.querySelectorAll('button')).find(b => b.innerText.trim() === 'Send');
        if (sendBtn && !isSendPage && !document.getElementById('confirmSendButton')) {
             const detailBalance = document.querySelector('section._heroCard_1h6wr_81 dd');
             if (detailBalance) {
                 const bal = parseFloat(detailBalance.innerText.replace(/[^0-9.]/g, ''));
                 if (bal < parseFloat(CONFIG.transferAmount)) {
                     updateUI("è¯¦æƒ…é¡µä½™é¢ä¸è¶³ï¼Œè¿”å›æŒ‚æœº...");
                     startWaiting();
                     window.location.href = "https://cantonloop.com/dashboard";
                     return;
                 }
             }
             updateUI("ç‚¹å‡» Send...");
             sendBtn.click();
             await sleep(2000);
             return;
        }

        // 6. å‘é€æµç¨‹ (åœ°å€ -> é‡‘é¢ -> ç¡®è®¤)
        if (isSendPage) {
            await processSendingFlow();
        }
    }

    // é”®ç›˜ç›‘å¬
    document.addEventListener('keydown', (e) => {
        if (e.altKey && e.key.toLowerCase() === CONFIG.hotkeyStart) {
            if (currentStatus === STATE.STOPPED) {
                currentStatus = STATE.RUNNING;
                GM_setValue('scriptStatus', STATE.RUNNING);
                updateUI("å¯åŠ¨ä¸­...");
                setTimeout(() => window.location.reload(), 500);
            } else {
                currentStatus = STATE.STOPPED;
                GM_setValue('scriptStatus', STATE.STOPPED);
                updateUI("å·²åœæ­¢");
            }
        }
    });

    setInterval(mainLoop, 1500);

})();
