// ==UserScript==
// @name         CantonLoop Auto Transfer Bot (Mac/Win) - V2.3 StrictLoad
// @namespace    http://tampermonkey.net/
// @version      1.0
// @description  CantonLoop è‡ªåŠ¨ bot - 
// @author       You
// @match        https://cantonloop.com/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=cantonloop.com
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_addStyle
// ==/UserScript==

(function() {
    'use strict';

    // ==========================================
    // 1. ç”¨æˆ·é…ç½®
    // ==========================================
    const CONFIG = {
        MAX_TRANSFERS: 12,               // ç›®æ ‡è½¬è´¦æ¬¡æ•°
        TARGET_ADDRESS: "æ­¤å¤„å¡«å†™ä½ çš„ç›®æ ‡é’±åŒ…åœ°å€", // ç›®æ ‡é’±åŒ…åœ°å€
        PASSWORD: "æ­¤å¤„å¡«å†™ä½ çš„å¯†ç ",          // å¯†ç 
        AMOUNT: "0.000001",              // é‡‘é¢
        WAIT_TIME_SECONDS: 360,           // è½¬è´¦æˆåŠŸåçš„å†·å´æ—¶é—´
    };

    // ==========================================
    // 2. çŠ¶æ€ç®¡ç†
    // ==========================================
    const STORAGE_KEY = 'canton_bot_state_v2_3';

    function getState() {
        const s = localStorage.getItem(STORAGE_KEY);
        return s ? JSON.parse(s) : { 
            isRunning: false, 
            successCount: 0, 
            checkingOffers: true, 
            lastOfferCheckTime: 0, 
            currentAction: 'IDLE', 
            nextRunTime: 0 
        };
    }

    function setState(newState) {
        const current = getState();
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ ...current, ...newState }));
        updateDashboard();
    }

    // ==========================================
    // 3. æ ¸å¿ƒå·¥å…· (æ™ºèƒ½ç­‰å¾… & Reactäº¤äº’)
    // ==========================================
    

    function waitForElement(selector, timeout = 10000) {
        return new Promise((resolve) => {
            if (document.querySelector(selector)) {
                return resolve(document.querySelector(selector));
            }
            const observer = new MutationObserver(() => {
                if (document.querySelector(selector)) {
                    observer.disconnect();
                    resolve(document.querySelector(selector));
                }
            });
            observer.observe(document.body, { childList: true, subtree: true });
            setTimeout(() => {
                observer.disconnect();
                resolve(null);
            }, timeout);
        });
    }

    function setNativeValue(element, value) {
        const lastValue = element.value;
        element.value = value;
        const tracker = element._valueTracker;
        if (tracker) tracker.setValue(lastValue);
        element.dispatchEvent(new Event('input', { bubbles: true }));
    }

    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    // ==========================================
    // 4. é¡µé¢è¯†åˆ« & åŠ¨ä½œ 
    // ==========================================
    function identifyPage() {
        if (document.querySelector('input[type="password"]')) return 'PAGE_PASSWORD';
        if (document.getElementById('confirmSendButton')) return 'PAGE_CONFIRM';
        if (document.getElementById('value') && document.querySelector('button[type="submit"]')) return 'PAGE_FILL_AMOUNT';
        if (document.getElementById('recipient')) return 'PAGE_FILL_ADDRESS';
        
        // é¡µé¢çº§åˆ¤æ–­
        const url = window.location.href;
        if (url.includes('/offers')) return 'PAGE_OFFERS';
        if (url.includes('/asset/CBTC')) return 'PAGE_ASSET_MAIN';
        if (url.includes('/dashboard')) return 'PAGE_DASHBOARD';
        
        return 'PAGE_UNKNOWN';
    }

    // --- å¯†ç å¤„ç† ---
    async function actionPassword() {
        const passwordInput = await waitForElement('input[type="password"]', 5000);
        if (!passwordInput) return;

        const continueBtns = Array.from(document.querySelectorAll('button'))
            .filter(b => b.innerText.includes('Continue') && b.offsetParent !== null);

        if (continueBtns.length > 0) {
            if (passwordInput.value !== CONFIG.PASSWORD) {
                setNativeValue(passwordInput, CONFIG.PASSWORD);
                await sleep(500);
            }
            const targetBtn = continueBtns[continueBtns.length - 1];
            if (!targetBtn.disabled) {
                targetBtn.style.border = "2px solid red";
                targetBtn.click();
                
                const s = getState();
                if (!s.checkingOffers) {
                    if (Date.now() > s.nextRunTime) {
                        setState({ 
                            successCount: s.successCount + 1, 
                            nextRunTime: Date.now() + (CONFIG.WAIT_TIME_SECONDS * 1000) 
                        });
                    }
                }
                await sleep(3000); // ç‚¹å‡»åç­‰å¾…è·³è½¬
            } else {
                passwordInput.dispatchEvent(new Event('input', { bubbles: true }));
                await sleep(500);
            }
        }
    }

    // --- Offers å¤„ç† (ä¸¥æ ¼åŠ è½½) ---
    async function actionCheckOffers() {
        updateDashboardWithText("ç­‰å¾… Offers åˆ—è¡¨åŠ è½½...");
        const title = await waitForElement('._title_1yzt5_72', 10000);
        if (!title) {
            console.log("Offers é¡µé¢åŠ è½½è¶…æ—¶");
            return;
        }

        const btns = document.querySelectorAll('button[title="Accept"]');
        if (btns.length > 0) {
            console.log(`ğŸ’¡ å‘ç° ${btns.length} ä¸ª Offer...`);
            btns[0].click(); 
            await sleep(2000); 
        } else {
            console.log("âœ… Offers ä¸ºç©ºï¼Œåˆ‡æ¢è‡³è½¬è´¦æ¨¡å¼");
            setState({ checkingOffers: false, lastOfferCheckTime: Date.now() }); 
            window.location.href = 'https://cantonloop.com/asset/CBTC';
        }
    }

    // --- å¡«åœ°å€ (ä¸¥æ ¼åŠ è½½) ---
    async function actionFillAddress() {
        const input = await waitForElement('#recipient', 5000);
        if (!input) return;

        if (input.value !== CONFIG.TARGET_ADDRESS) {
            setNativeValue(input, CONFIG.TARGET_ADDRESS);
            await sleep(800);
        }
        // ç­‰å¾… Next æŒ‰é’®å˜äº®
        const nextBtn = document.querySelector('button[type="submit"]:not([disabled])');
        if (nextBtn) {
            nextBtn.click();
            await sleep(2000);
        }
    }

    // --- å¡«é‡‘é¢ (ä¸¥æ ¼åŠ è½½) ---
    async function actionFillAmount() {
        const input = await waitForElement('#value', 5000);
        if (!input) return;
        
        // ç­‰å¾…ä½™é¢åŠ è½½ä»¥è¿›è¡Œé˜²å¾¡æ€§æ£€æŸ¥
        const availBtn = await waitForElement('button._availableValue_1u2j6_116', 5000);
        if(availBtn && parseFloat(availBtn.innerText.replace(/[^0-9.]/g, '')) < parseFloat(CONFIG.AMOUNT)) {
             window.location.href = "https://cantonloop.com/dashboard";
             return;
        }

        setNativeValue(input, CONFIG.AMOUNT);
        await sleep(1000);

        const continueBtn = document.querySelector('button[type="submit"]:not([disabled])');
        if (continueBtn) {
            continueBtn.click();
            await sleep(2000);
        }
    }

    // --- ç¡®è®¤é¡µ ---
    async function actionConfirm() {
        const btn = await waitForElement('#confirmSendButton', 5000);
        if (btn) {
            btn.click();
            await sleep(2000);
        }
    }

    // --- èµ„äº§/è½¬è´¦ä¸»é¡µ (ä¸¥æ ¼åŠ è½½ä½™é¢) ---
    async function actionAssetMain() {
        updateDashboardWithText("ç­‰å¾…ä½™é¢æ•°æ®åŠ è½½...");
        
        const balEl = await waitForElement('dl > dd', 10000);
        
        if (!balEl) {
            console.log("â³ ä½™é¢åŠ è½½è¶…æ—¶ï¼Œåˆ·æ–°é‡è¯•...");
            location.reload();
            return;
        }

        const balance = parseFloat(balEl.innerText);
        console.log(`ğŸ’° å½“å‰ä½™é¢: ${balance}`);
        
        if (balance <= parseFloat(CONFIG.AMOUNT)) {
            const s = getState();
            const timeSinceLastCheck = Date.now() - (s.lastOfferCheckTime || 0);
            
            if (timeSinceLastCheck < 30000) { 
                updateDashboardWithText("ä½™é¢ä¸è¶³ï¼Œç­‰å¾…åˆ·æ–°...");
                await sleep(5000);
                location.reload(); 
                return;
            }

            console.log("âš ï¸ ä½™é¢ä¸è¶³ -> å»æ”¶ Offer");
            setState({ checkingOffers: true });
            window.location.href = 'https://cantonloop.com/offers';
            await sleep(3000);
            return;
        }

        // ä½™é¢å……è¶³ï¼Œç­‰å¾… Send æŒ‰é’®
        const sendBtn = Array.from(document.querySelectorAll('button')).find(b => b.textContent.includes('Send'));
        if (sendBtn) {
            sendBtn.click();
            await sleep(2000);
        }
    }

    // --- Dashboard é¦–é¡µ (ä¸¥æ ¼åŠ è½½ Token åˆ—è¡¨) ---
    async function actionDashboard() {
        const s = getState();
        
        if (s.checkingOffers) {
             window.location.href = 'https://cantonloop.com/offers';
             return;
        }

        updateDashboardWithText("ç­‰å¾… Token åˆ—è¡¨...");
        
        const listWrapper = await waitForElement('._listWrapper_r9kp1_16', 15000);
        if (!listWrapper) {
            console.log("Dashboard åˆ—è¡¨åŠ è½½è¶…æ—¶ï¼Œåˆ·æ–°...");
            location.reload();
            return;
        }

        // åœ¨åˆ—è¡¨ä¸­å¯»æ‰¾ CBTC
        const btns = Array.from(document.querySelectorAll('button._wrapper_1og66_9'));
        const cbtcBtn = btns.find(b => b.innerText.includes('CBTC'));

        if (cbtcBtn) {
            updateDashboardWithText("ç‚¹å‡» CBTC...");
            cbtcBtn.click();
            await sleep(2000);
        } else {
            window.location.href = 'https://cantonloop.com/asset/CBTC';
        }
    }

    // ==========================================
    // 5. ä¸»å¾ªç¯
    // ==========================================
    function createDashboard() {
        if (document.getElementById('canton-bot-dashboard')) return;
        const div = document.createElement('div');
        div.id = 'canton-bot-dashboard';
        div.innerHTML = `
            <div style="border-bottom:1px solid #555; padding-bottom:5px; margin-bottom:5px; font-weight:bold;">ğŸ¤– Canton Bot V2.3</div>
            <div>çŠ¶æ€: <span id="bot-status">--</span></div>
            <div>æ¨¡å¼: <span id="bot-mode" style="color:yellow">--</span></div>
            <div>è®¡æ•°: <span id="bot-count" style="color:#00e5ff">0</span> / ${CONFIG.MAX_TRANSFERS}</div>
            <div style="font-size:10px; margin-top:5px; color:#ddd;">åŠ¨ä½œ: <span id="bot-action">...</span></div>
            <div style="font-size:10px; color:#888; margin-top:5px; border-top:1px solid #444; padding-top:2px;">Win: Alt+S | Mac: Opt+S</div>
        `;
        document.body.appendChild(div);
    }

    function updateDashboardWithText(text) {
        const actEl = document.getElementById('bot-action');
        if(actEl) actEl.innerText = text;
    }

    function updateDashboard() {
        const s = getState();
        const stEl = document.getElementById('bot-status');
        const mdEl = document.getElementById('bot-mode');
        const cntEl = document.getElementById('bot-count');
        const actEl = document.getElementById('bot-action');
        if (stEl) {
            stEl.innerText = s.isRunning ? "è¿è¡Œä¸­" : "å·²åœæ­¢";
            stEl.style.color = s.isRunning ? "#4CAF50" : "#F44336";
        }
        if (mdEl) {
            mdEl.innerText = s.checkingOffers ? "æ¸…Offers" : "è½¬è´¦";
        }
        if (cntEl) cntEl.innerText = s.successCount;
        if (actEl) actEl.innerText = s.currentAction; // é»˜è®¤æ˜¾ç¤º Page ID
    }

    GM_addStyle(`
        #canton-bot-dashboard {
            position: fixed; top: 10px; left: 10px; z-index: 999999;
            background: rgba(0,0,0,0.85); color: white; padding: 12px;
            border-radius: 8px; font-family: monospace; font-size: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); min-width: 140px;
            backdrop-filter: blur(4px); user-select: none; pointer-events: none;
        }
    `);

    async function mainLoop() {
        const state = getState();
        if (!state.isRunning) return;

        if (state.successCount >= CONFIG.MAX_TRANSFERS) {
            setState({ isRunning: false, currentAction: 'å·²å®Œæˆ' });
            alert("âœ… ä»»åŠ¡å®Œæˆï¼");
            return;
        }

        const page = identifyPage();
        
        // ä¼˜å…ˆå¤„ç† Offer æ¨¡å¼çš„è·³è½¬
        if (state.checkingOffers) {
            if (page === 'PAGE_PASSWORD') { /* ç»§ç»­æ‰§è¡Œ switch */ }
            else if (page === 'PAGE_OFFERS') { /* ç»§ç»­æ‰§è¡Œ switch */ }
            else if (!window.location.href.includes('/offers')) {
                setState({ currentAction: 'å» Offers...' });
                window.location.href = 'https://cantonloop.com/offers';
                return;
            }
        }

        // å†·å´é€»è¾‘ (ä»…è½¬è´¦æ¨¡å¼)
        const isProcessPage = ['PAGE_PASSWORD', 'PAGE_CONFIRM', 'PAGE_FILL_AMOUNT', 'PAGE_FILL_ADDRESS'].includes(page);
        if (!isProcessPage && !state.checkingOffers && Date.now() < state.nextRunTime) {
            const wait = Math.ceil((state.nextRunTime - Date.now()) / 1000);
            updateDashboardWithText(`å†·å´ä¸­ ${wait}s`);
            if (wait <= 1 && !window.location.href.includes('asset/CBTC')) {
                window.location.href = 'https://cantonloop.com/asset/CBTC';
            }
            return;
        }

        if (state.currentAction !== page) setState({ currentAction: page });

        switch (page) {
            case 'PAGE_PASSWORD': await actionPassword(); break;
            case 'PAGE_CONFIRM': await actionConfirm(); break;
            case 'PAGE_FILL_AMOUNT': await actionFillAmount(); break;
            case 'PAGE_FILL_ADDRESS': await actionFillAddress(); break;
            case 'PAGE_ASSET_MAIN': await actionAssetMain(); break;
            case 'PAGE_DASHBOARD': await actionDashboard(); break;
            case 'PAGE_OFFERS': 
                if (!state.checkingOffers) setState({ checkingOffers: true });
                await actionCheckOffers(); 
                break;
            case 'PAGE_UNKNOWN':
                if (!window.location.href.includes('cantonloop.com')) return;
                // å¦‚æœå¡åœ¨æœªçŸ¥é¡µé¢å¤ªä¹…ï¼Œå¯ä»¥è€ƒè™‘åˆ·æ–°
                break;
        }
    }

    window.addEventListener('keydown', (e) => {
        if (e.altKey && e.code === 'KeyS') {
            e.preventDefault(); e.stopPropagation();
            const s = getState();
            if (s.isRunning) {
                setState({ isRunning: false, currentAction: 'å·²åœæ­¢' });
            } else {
                if(confirm('å¯åŠ¨è‡ªåŠ¨è„šæœ¬ï¼Ÿ')) {
                    setState({ isRunning: true, successCount: 0, checkingOffers: true });
                    location.reload();
                }
            }
        }
    }, true);

    function init() {
        createDashboard();
        updateDashboard();
        setInterval(mainLoop, 1500);
    }

    if (document.readyState === 'complete') init();
    else window.addEventListener('load', init);

})();
