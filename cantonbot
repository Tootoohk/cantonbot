// ==UserScript==
// @name         CantonLoop Auto Bot V3.1 (Full Address List)
// @namespace    http://tampermonkey.net/
// @version      3.1
// @description  CantonLoop è‡ªåŠ¨è„šæœ¬ -æ”¯æŒåºå·è¯¢é—®ã€è‡ªåŠ¨è¡¥é½10æ¬¡è½¬è´¦ã€Offersç›‘æ§
// @author       You
// @match        https://cantonloop.com/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=cantonloop.com
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_addStyle
// ==/UserScript==

(function() {
    'use strict';

    // ==========================================
    // 1. ç”¨æˆ·é…ç½®
    // ==========================================
    const CONFIG = {
        // ã€æ ¸å¿ƒé…ç½®ã€‘å†…ç½®åœ°å€åº“
        ADDRESS_LIBRARY: [
            "åœ°å€1",
            "åœ°å€2",
            "åœ°å€3",
            "åœ°å€4"    
            //æœ€åä¸€ä¸ªåœ°å€åé¢ä¸è¦æœ‰é€—å·
        ],

        PASSWORD: "æ­¤å¤„å¡«å†™ä½ çš„å¯†ç ",          // å¯†ç 
        AMOUNT: "0.000001",              // é‡‘é¢
        TRANSFER_COOLDOWN: 60,           // è½¬è´¦æˆåŠŸåå†·å´(ç§’)
        MONITOR_INTERVAL: 180            // ä»»åŠ¡å®Œæˆåç›‘æ§åˆ·æ–°(ç§’)
    };

    // ==========================================
    // 2. çŠ¶æ€ç®¡ç†
    // ==========================================
    const STORAGE_KEY = 'canton_bot_state_v3_1';

    const MODE = {
        STOPPED: 'STOPPED',
        PHASE_1_CLEAR_OFFERS: 'PHASE_1_CLEAR_OFFERS',
        PHASE_2_TRANSFER_TASK: 'PHASE_2_TRANSFER_TASK',
        PHASE_3_MONITOR: 'PHASE_3_MONITOR'
    };

    function getState() {
        const s = localStorage.getItem(STORAGE_KEY);
        return s ? JSON.parse(s) : { 
            mode: MODE.STOPPED,
            targetList: [],          // æœ¬æ¬¡ä»»åŠ¡çš„ç›®æ ‡åœ°å€
            currentTargetIndex: 0,   // å½“å‰æ­£åœ¨è½¬ç¬¬å‡ ä¸ªç›®æ ‡ (0-9)
            successCount: 0, 
            currentAction: 'IDLE', 
            nextRunTime: 0 
        };
    }

    function setState(newState) {
        const current = getState();
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ ...current, ...newState }));
        updateDashboard();
    }

    // ==========================================
    // 3. æ ¸å¿ƒå·¥å…· (React å…¼å®¹)
    // ==========================================
    function waitForElement(selector, timeout = 10000) {
        return new Promise((resolve) => {
            if (document.querySelector(selector)) return resolve(document.querySelector(selector));
            const observer = new MutationObserver(() => {
                if (document.querySelector(selector)) {
                    observer.disconnect();
                    resolve(document.querySelector(selector));
                }
            });
            observer.observe(document.body, { childList: true, subtree: true });
            setTimeout(() => { observer.disconnect(); resolve(null); }, timeout);
        });
    }

    function setNativeValue(element, value) {
        const lastValue = element.value;
        element.value = value;
        const tracker = element._valueTracker;
        if (tracker) tracker.setValue(lastValue);
        element.dispatchEvent(new Event('input', { bubbles: true }));
    }

    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    // è®¡ç®—æ¥ä¸‹æ¥è¦è½¬è´¦çš„10ä¸ªåœ°å€ (å¾ªç¯è¡¥é½)
    function calculateTargetList(currentIndex, library) {
        const targets = [];
        const libLen = library.length;
        if (libLen === 0) return [];
        for (let i = 1; i <= 10; i++) {
            const targetIdx = (currentIndex + i) % libLen;
            targets.push(library[targetIdx]);
        }
        return targets;
    }

    // ==========================================
    // 4. é¡µé¢è¯†åˆ« & åŠ¨ä½œ
    // ==========================================
    function identifyPage() {
        if (document.querySelector('input[type="password"]')) return 'PAGE_PASSWORD';
        if (document.getElementById('confirmSendButton')) return 'PAGE_CONFIRM';
        if (document.getElementById('value') && document.querySelector('button[type="submit"]')) return 'PAGE_FILL_AMOUNT';
        if (document.getElementById('recipient')) return 'PAGE_FILL_ADDRESS';
        if (window.location.href.includes('/offers')) return 'PAGE_OFFERS';
        if (window.location.href.includes('/asset/CBTC')) return 'PAGE_ASSET_MAIN';
        if (window.location.href.includes('/dashboard')) return 'PAGE_DASHBOARD';
        return 'PAGE_UNKNOWN';
    }

    // --- å¯†ç å¤„ç† ---
    async function actionPassword() {
        const passwordInput = await waitForElement('input[type="password"]', 5000);
        if (!passwordInput) return;

        const continueBtns = Array.from(document.querySelectorAll('button'))
            .filter(b => b.innerText.includes('Continue') && b.offsetParent !== null);

        if (continueBtns.length > 0) {
            if (passwordInput.value !== CONFIG.PASSWORD) {
                setNativeValue(passwordInput, CONFIG.PASSWORD);
                await sleep(500);
            }
            const targetBtn = continueBtns[continueBtns.length - 1];
            if (!targetBtn.disabled) {
                targetBtn.style.border = "2px solid red";
                targetBtn.click();
                
                const s = getState();
                if (s.mode === MODE.PHASE_2_TRANSFER_TASK) {
                    const nextIndex = s.currentTargetIndex + 1;
                    console.log(`âœ… è½¬è´¦æˆåŠŸ (${nextIndex}/10)`);
                    
                    if (nextIndex >= 10) {
                         // ä»»åŠ¡å®Œæˆï¼Œåˆ‡ç›‘æ§
                         setState({ 
                            successCount: s.successCount + 1,
                            currentTargetIndex: nextIndex,
                            mode: MODE.PHASE_3_MONITOR, 
                            nextRunTime: Date.now() + 5000 
                         });
                    } else {
                        // ç»§ç»­è½¬è´¦
                        setState({ 
                            successCount: s.successCount + 1,
                            currentTargetIndex: nextIndex,
                            nextRunTime: Date.now() + (CONFIG.TRANSFER_COOLDOWN * 1000) 
                        });
                    }
                } else {
                    console.log("âœ… Offer æ¥æ”¶æˆåŠŸ");
                    setState({ nextRunTime: Date.now() + 2000 });
                }
                await sleep(3000);
            } else {
                passwordInput.dispatchEvent(new Event('input', { bubbles: true }));
                await sleep(500);
            }
        }
    }

    // --- Offers å¤„ç† ---
    async function actionCheckOffers() {
        updateDashboardWithText("åŠ è½½ Offers...");
        const title = await waitForElement('._title_1yzt5_72', 10000);
        if (!title) { location.reload(); return; }

        const btns = document.querySelectorAll('button[title="Accept"]');
        const s = getState();

        if (btns.length > 0) {
            console.log(`ğŸ’¡ å‘ç° ${btns.length} ä¸ª Offer...`);
            btns[0].click(); 
            await sleep(2000); 
        } else {
            console.log("âœ… æ— å¾…ç¡®è®¤äº¤æ˜“");
            if (s.mode === MODE.PHASE_1_CLEAR_OFFERS) {
                console.log("â¡ï¸ åˆå§‹æ¸…ç†å®Œæˆ -> å¼€å§‹è½¬è´¦ä»»åŠ¡");
                setState({ mode: MODE.PHASE_2_TRANSFER_TASK });
                window.location.href = 'https://cantonloop.com/asset/CBTC';
            } else if (s.mode === MODE.PHASE_3_MONITOR) {
                console.log("ğŸ”’ ç›‘æ§æŒ‚æœºä¸­...");
                setState({ nextRunTime: Date.now() + (CONFIG.MONITOR_INTERVAL * 1000) });
            } else if (s.mode === MODE.PHASE_2_TRANSFER_TASK) {
                 window.location.href = 'https://cantonloop.com/asset/CBTC';
            }
        }
    }

    // --- å¡«åœ°å€ ---
    async function actionFillAddress() {
        const input = await waitForElement('#recipient', 5000);
        if (!input) return;

        const s = getState();
        if (s.currentTargetIndex >= s.targetList.length) {
            setState({ mode: MODE.PHASE_3_MONITOR });
            window.location.href = 'https://cantonloop.com/offers';
            return;
        }

        const targetAddress = s.targetList[s.currentTargetIndex];
        updateDashboardWithText(`å¡«ç¬¬ ${s.currentTargetIndex + 1}/10 ä¸ªåœ°å€`);

        if (input.value !== targetAddress) {
            setNativeValue(input, targetAddress);
            await sleep(800);
        }
        
        const nextBtn = document.querySelector('button[type="submit"]:not([disabled])');
        if (nextBtn) { nextBtn.click(); await sleep(2000); }
    }

    async function actionFillAmount() {
        const input = await waitForElement('#value', 5000);
        if (!input) return;
        
        const availBtn = await waitForElement('button._availableValue_1u2j6_116', 5000);
        if(availBtn && parseFloat(availBtn.innerText.replace(/[^0-9.]/g, '')) < parseFloat(CONFIG.AMOUNT)) {
             window.location.href = "https://cantonloop.com/dashboard";
             return;
        }
        setNativeValue(input, CONFIG.AMOUNT);
        await sleep(1000);
        const continueBtn = document.querySelector('button[type="submit"]:not([disabled])');
        if (continueBtn) { continueBtn.click(); await sleep(2000); }
    }

    async function actionConfirm() {
        const btn = await waitForElement('#confirmSendButton', 5000);
        if (btn) { btn.click(); await sleep(2000); }
    }

    async function actionAssetMain() {
        updateDashboardWithText("æ£€æŸ¥ä½™é¢...");
        const balEl = await waitForElement('dl > dd', 10000);
        if (!balEl) { location.reload(); return; }

        const balance = parseFloat(balEl.innerText);
        if (balance <= parseFloat(CONFIG.AMOUNT)) {
            console.log("âš ï¸ ä½™é¢ä¸è¶³ï¼Œå» Offers æš‚é¿");
            window.location.href = 'https://cantonloop.com/offers';
            await sleep(3000);
            return;
        }
        const sendBtn = Array.from(document.querySelectorAll('button')).find(b => b.textContent.includes('Send'));
        if (sendBtn) { sendBtn.click(); await sleep(2000); }
    }

    async function actionDashboard() {
        const s = getState();
        if (s.mode !== MODE.PHASE_2_TRANSFER_TASK) {
             window.location.href = 'https://cantonloop.com/offers';
             return;
        }
        const listWrapper = await waitForElement('._listWrapper_r9kp1_16', 15000);
        if (!listWrapper) { location.reload(); return; }
        const btns = Array.from(document.querySelectorAll('button._wrapper_1og66_9'));
        const cbtcBtn = btns.find(b => b.innerText.includes('CBTC'));
        if (cbtcBtn) { cbtcBtn.click(); await sleep(2000); }
        else { window.location.href = 'https://cantonloop.com/asset/CBTC'; }
    }

    // ==========================================
    // 5. ä¸»å¾ªç¯ & UI
    // ==========================================
    function createDashboard() {
        if (document.getElementById('canton-bot-dashboard')) return;
        const div = document.createElement('div');
        div.id = 'canton-bot-dashboard';
        div.innerHTML = `
            <div style="border-bottom:1px solid #555; padding-bottom:5px; margin-bottom:5px; font-weight:bold;">ğŸ¤– Canton Bot V3.1</div>
            <div>çŠ¶æ€: <span id="bot-status">--</span></div>
            <div>é˜¶æ®µ: <span id="bot-mode" style="color:yellow">--</span></div>
            <div>è¿›åº¦: <span id="bot-target-info" style="color:#00e5ff">--</span></div>
            <div style="font-size:10px; margin-top:5px; color:#ddd;">åŠ¨ä½œ: <span id="bot-action">...</span></div>
            <div style="font-size:10px; color:#888; margin-top:5px; border-top:1px solid #444; padding-top:2px;">Win: Alt+S | Mac: Opt+S</div>
        `;
        document.body.appendChild(div);
    }

    function updateDashboardWithText(text) {
        const actEl = document.getElementById('bot-action');
        if(actEl) actEl.innerText = text;
    }

    function updateDashboard() {
        const s = getState();
        const stEl = document.getElementById('bot-status');
        const mdEl = document.getElementById('bot-mode');
        const infoEl = document.getElementById('bot-target-info');
        const actEl = document.getElementById('bot-action');
        
        if (stEl) {
            stEl.innerText = s.mode !== MODE.STOPPED ? "è¿è¡Œä¸­" : "å·²åœæ­¢";
            stEl.style.color = s.mode !== MODE.STOPPED ? "#4CAF50" : "#F44336";
        }
        if (mdEl) {
            const map = {
                'PHASE_1_CLEAR_OFFERS': '1.æ¸…ç©º Offers',
                'PHASE_2_TRANSFER_TASK': '2.è½¬è´¦ä»»åŠ¡',
                'PHASE_3_MONITOR': '3.ç›‘æ§æŒ‚æœº',
                'STOPPED': 'åœæ­¢'
            };
            mdEl.innerText = map[s.mode] || s.mode;
        }
        if (infoEl) {
            if (s.mode === MODE.PHASE_2_TRANSFER_TASK) {
                infoEl.innerText = `${s.currentTargetIndex} / 10`;
            } else if (s.mode === MODE.PHASE_3_MONITOR) {
                infoEl.innerText = "ç›‘æ§åˆ·æ–°...";
            } else {
                infoEl.innerText = "--";
            }
        }
        if (actEl) actEl.innerText = s.currentAction;
    }

    GM_addStyle(`
        #canton-bot-dashboard {
            position: fixed; top: 10px; left: 10px; z-index: 999999;
            background: rgba(0,0,0,0.85); color: white; padding: 12px;
            border-radius: 8px; font-family: monospace; font-size: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); min-width: 150px;
            backdrop-filter: blur(4px); user-select: none; pointer-events: none;
        }
    `);

    async function mainLoop() {
        const state = getState();
        if (state.mode === MODE.STOPPED) return;

        const page = identifyPage();
        const isProcessPage = ['PAGE_PASSWORD', 'PAGE_CONFIRM', 'PAGE_FILL_AMOUNT', 'PAGE_FILL_ADDRESS'].includes(page);

        // å†·å´/å€’è®¡æ—¶
        if (Date.now() < state.nextRunTime && !isProcessPage) {
            const wait = Math.ceil((state.nextRunTime - Date.now()) / 1000);
            updateDashboardWithText(`ç­‰å¾…: ${wait}s`);
            
            if (wait <= 0) {
                if (state.mode === MODE.PHASE_3_MONITOR) {
                    location.reload();
                    return;
                }
            } else {
                // ç›‘æ§æ¨¡å¼å€’è®¡æ—¶ä¸­å¼ºåˆ¶ç•™åœ¨Offers
                if (state.mode === MODE.PHASE_3_MONITOR && !window.location.href.includes('/offers')) {
                    window.location.href = 'https://cantonloop.com/offers';
                }
                return;
            }
        }

        // é˜¶æ®µè°ƒåº¦
        if (state.mode === MODE.PHASE_1_CLEAR_OFFERS || state.mode === MODE.PHASE_3_MONITOR) {
            if (page === 'PAGE_PASSWORD') { /* continue */ }
            else if (page === 'PAGE_OFFERS') { /* continue */ }
            else if (!window.location.href.includes('/offers')) {
                updateDashboardWithText("å» Offers...");
                window.location.href = 'https://cantonloop.com/offers';
                return;
            }
        }
        
        if (state.mode === MODE.PHASE_2_TRANSFER_TASK) {
            if (page !== 'PAGE_ASSET_MAIN' && !isProcessPage && !window.location.href.includes('asset/CBTC')) {
                 // handled by dashboard switch
            }
        }

        if (state.currentAction !== page) setState({ currentAction: page });

        switch (page) {
            case 'PAGE_PASSWORD': await actionPassword(); break;
            case 'PAGE_CONFIRM': await actionConfirm(); break;
            case 'PAGE_FILL_AMOUNT': await actionFillAmount(); break;
            case 'PAGE_FILL_ADDRESS': await actionFillAddress(); break;
            case 'PAGE_ASSET_MAIN': await actionAssetMain(); break;
            case 'PAGE_DASHBOARD': await actionDashboard(); break;
            case 'PAGE_OFFERS': await actionCheckOffers(); break;
            case 'PAGE_UNKNOWN':
                if (window.location.href.includes('dashboard') && !window.location.href.includes('asset')) {
                   await actionDashboard();
                }
                break;
        }
    }

    // å¿«æ·é”®å¯åŠ¨
    window.addEventListener('keydown', (e) => {
        if (e.altKey && e.code === 'KeyS') {
            e.preventDefault(); e.stopPropagation();
            const s = getState();
            
            if (s.mode !== MODE.STOPPED) {
                setState({ mode: MODE.STOPPED, currentAction: 'å·²åœæ­¢' });
            } else {
                const libLen = CONFIG.ADDRESS_LIBRARY.length;
                if (libLen === 0) {
                    alert("è¯·å…ˆåœ¨è„šæœ¬ä»£ç ä¸­é…ç½® ADDRESS_LIBRARY");
                    return;
                }

                const input = prompt(`ã€å¯åŠ¨é…ç½®ã€‘\nåœ°å€åº“å…±æœ‰ ${libLen} ä¸ªåœ°å€ã€‚\nè¯·è¾“å…¥å½“å‰ç™»å½•é’±åŒ…çš„åºå· (1 - ${libLen}):\n(ä¾‹å¦‚ç¬¬2ä¸ªåœ°å€ï¼Œè¯·è¾“å…¥ 2)`);
                const idx = parseInt(input);
                
                if (isNaN(idx) || idx < 1 || idx > libLen) {
                    alert("åºå·æ— æ•ˆï¼Œå·²å–æ¶ˆå¯åŠ¨");
                    return;
                }

                // è®¡ç®—
                const myIndex0 = idx - 1; 
                const targetList = calculateTargetList(myIndex0, CONFIG.ADDRESS_LIBRARY);
                
                console.log("ç›®æ ‡åˆ—è¡¨:", targetList);
                alert(`âœ… è„šæœ¬å¯åŠ¨ï¼\n\n1. æ¸…ç©ºå½“å‰å¾…ç¡®è®¤äº¤æ˜“\n2. ç»™åç»­ 10 ä¸ªåœ°å€è½¬è´¦\n3. ä»»åŠ¡å®ŒæˆåæŒ‚æœºç›‘æ§`);

                setState({ 
                    mode: MODE.PHASE_1_CLEAR_OFFERS, 
                    targetList: targetList,
                    currentTargetIndex: 0,
                    successCount: 0, 
                    nextRunTime: 0
                });
                location.reload();
            }
        }
    }, true);

    function init() {
        createDashboard();
        updateDashboard();
        setInterval(mainLoop, 1500);
    }

    if (document.readyState === 'complete') init();
    else window.addEventListener('load', init);

})();
