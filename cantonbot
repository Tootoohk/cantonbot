// ==UserScript==
// @name         CantonLoop Auto Bot V3.5 (Error Detection)
// @namespace    http://tampermonkey.net/
// @version      3.5
// @description  CantonLoop è‡ªåŠ¨è„šæœ¬ 
// @author       You
// @match        https://cantonloop.com/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=cantonloop.com
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_addStyle
// ==/UserScript==

(function() {
    'use strict';

    // ==========================================
    // 1. ç”¨æˆ·é…ç½®
    // ==========================================
    const CONFIG = {
        // ã€æ ¸å¿ƒé…ç½®ã€‘åœ°å€åº“
        ADDRESS_LIBRARY: [
            "åœ°å€1_xxxxxxxxxxx",
            "åœ°å€2_xxxxxxxxxxx",
            // ... è¯·å¡«å…¥æ‰€æœ‰åœ°å€
        ],

        PASSWORD: "æ­¤å¤„å¡«å†™ä½ çš„å¯†ç ",          // å¯†ç 
        AMOUNT: "0.000001",              // è½¬è´¦é‡‘é¢
        TRANSFER_COOLDOWN: 60,           // è½¬è´¦æˆåŠŸåçš„å†·å´æ—¶é—´ (ç§’)
        MONITOR_INTERVAL: 180            // ä»»åŠ¡å®Œæˆåç›‘æ§åˆ·æ–°é—´éš” (ç§’)
    };

    // ==========================================
    // 2. çŠ¶æ€ç®¡ç†
    // ==========================================
    const STORAGE_KEY = 'canton_bot_state_v3_5';

    const MODE = {
        STOPPED: 'STOPPED',
        PHASE_1_CLEAR_OFFERS: 'PHASE_1_CLEAR_OFFERS',
        PHASE_2_TRANSFER_TASK: 'PHASE_2_TRANSFER_TASK',
        PHASE_3_MONITOR: 'PHASE_3_MONITOR'
    };

    function getState() {
        const s = localStorage.getItem(STORAGE_KEY);
        return s ? JSON.parse(s) : { 
            mode: MODE.STOPPED,
            targetList: [],          
            currentTargetIndex: 0,   
            lastOfferCheckTime: 0,   
            consecutiveOffers: 0,    
            successCount: 0, 
            currentAction: 'IDLE', 
            nextRunTime: 0 
        };
    }

    function setState(newState) {
        const current = getState();
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ ...current, ...newState }));
        updateDashboard();
    }

    // ==========================================
    // 3. æ ¸å¿ƒå·¥å…·
    // ==========================================
    function waitForElement(selector, timeout = 10000) {
        return new Promise((resolve) => {
            if (document.querySelector(selector)) return resolve(document.querySelector(selector));
            const observer = new MutationObserver(() => {
                if (document.querySelector(selector)) {
                    observer.disconnect();
                    resolve(document.querySelector(selector));
                }
            });
            observer.observe(document.body, { childList: true, subtree: true });
            setTimeout(() => { observer.disconnect(); resolve(null); }, timeout);
        });
    }

    function setNativeValue(element, value) {
        const lastValue = element.value;
        element.value = value;
        const tracker = element._valueTracker;
        if (tracker) tracker.setValue(lastValue);
        element.dispatchEvent(new Event('input', { bubbles: true }));
    }

    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    function calculateTargetList(currentIndex, library) {
        const targets = [];
        const libLen = library.length;
        if (libLen === 0) return [];
        for (let i = 1; i <= 10; i++) {
            const targetIdx = (currentIndex + i) % libLen;
            targets.push(library[targetIdx]);
        }
        return targets;
    }

    // ==========================================
    // 4. é”™è¯¯æ£€æµ‹é€»è¾‘ (æ–°å¢)
    // ==========================================
    
    // æ£€æŸ¥é¡µé¢æ˜¯å¦å­˜åœ¨é”™è¯¯æç¤º
    function checkForError() {
        // æ ¹æ®ä½ æä¾›çš„ HTML ç»“æ„æŸ¥æ‰¾é”™è¯¯æç¤º
        // <div class="_title_1eogf_50">CBTC transfers queue is full...</div>
        const errorDiv = document.querySelector('._title_1eogf_50');
        if (errorDiv && errorDiv.innerText.toLowerCase().includes('queue is full')) {
            return true;
        }
        return false;
    }

    // ==========================================
    // 5. é¡µé¢è¯†åˆ« & åŠ¨ä½œé€»è¾‘
    // ==========================================
    function identifyPage() {
        if (document.querySelector('input[type="password"]')) return 'PAGE_PASSWORD';
        if (document.getElementById('confirmSendButton')) return 'PAGE_CONFIRM';
        if (document.getElementById('value') && document.querySelector('button[type="submit"]')) return 'PAGE_FILL_AMOUNT';
        if (document.getElementById('recipient')) return 'PAGE_FILL_ADDRESS';
        if (window.location.href.includes('/offers')) return 'PAGE_OFFERS';
        if (window.location.href.includes('/asset/CBTC')) return 'PAGE_ASSET_MAIN';
        if (window.location.href.includes('/dashboard')) return 'PAGE_DASHBOARD';
        return 'PAGE_UNKNOWN';
    }

    // --- å¯†ç å¤„ç† (æ ¸å¿ƒä¿®å¤ï¼šå¢åŠ å¤±è´¥å›æ»š) ---
    async function actionPassword() {
        const passwordInput = await waitForElement('input[type="password"]', 5000);
        if (!passwordInput) return;

        const continueBtns = Array.from(document.querySelectorAll('button'))
            .filter(b => b.innerText.includes('Continue') && b.offsetParent !== null);

        if (continueBtns.length > 0) {
            if (passwordInput.value !== CONFIG.PASSWORD) {
                setNativeValue(passwordInput, CONFIG.PASSWORD);
                await sleep(500);
            }
            const targetBtn = continueBtns[continueBtns.length - 1];
            if (!targetBtn.disabled) {
                targetBtn.style.border = "2px solid red";
                targetBtn.click();
                
                updateDashboardWithText("æäº¤ä¸­ï¼Œæ ¡éªŒç»“æœ...");

                // ã€æ ¸å¿ƒå‡çº§ã€‘æäº¤åï¼Œè¿›å…¥ç›‘æ§æœŸ (çº¦8ç§’)ï¼Œæ£€æµ‹æ˜¯å¦æŠ¥é”™
                const s = getState();
                const isTransferTask = (s.mode === MODE.PHASE_2_TRANSFER_TASK && !window.location.href.includes('/offers'));
                
                // å¾ªç¯æ£€æµ‹é”™è¯¯
                for (let i = 0; i < 16; i++) { // 16 * 500ms = 8ç§’
                    await sleep(500);
                    
                    // 1. æ£€æµ‹é”™è¯¯
                    if (checkForError()) {
                        console.error("âŒ æ£€æµ‹åˆ°é˜Ÿåˆ—å·²æ»¡æŠ¥é”™ï¼è½¬è´¦å¤±è´¥ï¼");
                        updateDashboardWithText("å¤±è´¥: é˜Ÿåˆ—å·²æ»¡ï¼Œå‡†å¤‡é‡è¯•");
                        
                        // å¼ºåˆ¶åˆ·æ–°é¡µé¢ï¼Œä¸åšä»»ä½•çŠ¶æ€æ›´æ–°
                        // è¿™æ ·è„šæœ¬é‡å¯åï¼ŒcurrentTargetIndex è¿˜æ˜¯åŸæ¥çš„å€¼ï¼Œä¼šé‡è¯•å½“å‰åœ°å€
                        await sleep(1000);
                        location.reload(); 
                        return; // ä¸­æ–­åç»­é€»è¾‘
                    }

                    // 2. æ£€æµ‹å¼¹çª—æ˜¯å¦å·²æ¶ˆå¤± (ä¸”æ²¡æŠ¥é”™) -> è§†ä¸ºæˆåŠŸ
                    const modal = document.querySelector('input[type="password"]');
                    if (!modal) {
                        break; // å¼¹çª—æ²¡äº†ï¼Œè¯´æ˜æäº¤æˆåŠŸäº†
                    }
                }

                // --- å¦‚æœä»£ç èµ°åˆ°è¿™é‡Œï¼Œè¯´æ˜æ²¡æœ‰æ£€æµ‹åˆ°é”™è¯¯ï¼Œä¸”å¼¹çª—æ¶ˆå¤±äº† ---
                
                if (isTransferTask) {
                    const nextIndex = s.currentTargetIndex + 1;
                    console.log(`âœ… [è½¬è´¦] æˆåŠŸç¡®è®¤ (${nextIndex}/10)`);
                    
                    if (nextIndex >= 10) {
                         setState({ 
                            successCount: s.successCount + 1,
                            currentTargetIndex: nextIndex,
                            consecutiveOffers: 0, 
                            mode: MODE.PHASE_3_MONITOR, 
                            nextRunTime: Date.now() + 5000 
                         });
                    } else {
                        setState({ 
                            successCount: s.successCount + 1,
                            currentTargetIndex: nextIndex,
                            consecutiveOffers: 0, 
                            nextRunTime: Date.now() + (CONFIG.TRANSFER_COOLDOWN * 1000) 
                        });
                    }
                    await sleep(2000); 

                } else {
                    // Offer æ¨¡å¼
                    console.log("âœ… [Offer] æ¥æ”¶æˆåŠŸ");
                    const newOfferCount = (s.consecutiveOffers || 0) + 1;
                    if (newOfferCount >= 2) {
                        console.log("ğŸ”„ è¿ç»­2ç¬” Offerï¼Œåˆ·æ–°é˜²å¡...");
                        setState({ consecutiveOffers: 0, nextRunTime: 0 });
                        await sleep(2000);
                        location.reload();
                        return;
                    } else {
                        setState({ 
                            consecutiveOffers: newOfferCount,
                            nextRunTime: Date.now() + 2000 
                        });
                        await sleep(3000);
                    }
                }
            } else {
                passwordInput.dispatchEvent(new Event('input', { bubbles: true }));
                await sleep(500);
            }
        }
    }

    // --- Offers å¤„ç† ---
    async function actionCheckOffers() {
        updateDashboardWithText("åŠ è½½ Offers...");
        const title = await waitForElement('._title_1yzt5_72', 10000);
        if (!title) { location.reload(); return; }

        const btns = document.querySelectorAll('button[title="Accept"]');
        const s = getState();

        if (btns.length > 0) {
            console.log(`ğŸ’¡ å‘ç° ${btns.length} ä¸ª Offer...`);
            btns[0].click(); 
            updateDashboardWithText("ç‚¹å‡» Acceptï¼Œç­‰å¾…...");
            await sleep(3000); 
        } else {
            console.log("âœ… æ— å¾…ç¡®è®¤äº¤æ˜“");
            const now = Date.now();
            
            // é‡ç½® Offer è®¡æ•°
            setState({ consecutiveOffers: 0 });

            if (s.mode === MODE.PHASE_3_MONITOR) {
                console.log("ğŸ”’ ç›‘æ§æŒ‚æœºä¸­...");
                setState({ nextRunTime: now + (CONFIG.MONITOR_INTERVAL * 1000) });
            } 
            else if (s.mode === MODE.PHASE_1_CLEAR_OFFERS) {
                console.log("â¡ï¸ åˆå§‹æ¸…ç†å®Œæˆ -> å»è½¬è´¦");
                setState({ mode: MODE.PHASE_2_TRANSFER_TASK, lastOfferCheckTime: now });
                window.location.href = 'https://cantonloop.com/asset/CBTC';
            }
            else if (s.mode === MODE.PHASE_2_TRANSFER_TASK) {
                if (s.currentTargetIndex < 10) {
                    console.log("â¡ï¸ Offersç©ºï¼Œå›æµè½¬è´¦...");
                    setState({ lastOfferCheckTime: now });
                    window.location.href = 'https://cantonloop.com/asset/CBTC';
                } else {
                    setState({ mode: MODE.PHASE_3_MONITOR });
                }
            }
        }
    }

    // --- èµ„äº§é¡µé€»è¾‘ ---
    async function actionAssetMain() {
        updateDashboardWithText("æ£€æŸ¥ä½™é¢...");
        const balEl = await waitForElement('dl > dd', 10000);
        if (!balEl) { location.reload(); return; }

        const balance = parseFloat(balEl.innerText);
        const required = parseFloat(CONFIG.AMOUNT);
        
        if (balance < required) {
            const s = getState();
            // é˜²æŠ–
            const timeSinceCheck = Date.now() - (s.lastOfferCheckTime || 0);
            
            if (timeSinceCheck < 30000) {
                updateDashboardWithText("ä½™é¢æœªåˆ·æ–°ï¼Œç­‰å¾…...");
                await sleep(5000);
                location.reload(); 
                return;
            }

            console.log("âš ï¸ ä½™é¢ä¸è¶³ -> ä¸´æ—¶åˆ‡ Offers");
            setState({ lastOfferCheckTime: Date.now() }); 
            window.location.href = 'https://cantonloop.com/offers';
            return;
        }

        const sendBtn = Array.from(document.querySelectorAll('button')).find(b => b.textContent.includes('Send'));
        if (sendBtn) { sendBtn.click(); await sleep(2000); }
    }

    // --- å…¶ä»–åŠ¨ä½œ ---
    async function actionFillAddress() {
        const input = await waitForElement('#recipient', 5000);
        if (!input) return;
        const s = getState();
        if (s.currentTargetIndex >= 10) { 
            setState({ mode: MODE.PHASE_3_MONITOR });
            window.location.href = 'https://cantonloop.com/offers';
            return;
        }
        const targetAddress = s.targetList[s.currentTargetIndex];
        updateDashboardWithText(`å¡«ç¬¬ ${s.currentTargetIndex + 1}/10 ä¸ªåœ°å€`);
        if (input.value !== targetAddress) {
            setNativeValue(input, targetAddress);
            await sleep(800);
        }
        const nextBtn = document.querySelector('button[type="submit"]:not([disabled])');
        if (nextBtn) { nextBtn.click(); await sleep(2000); }
    }

    async function actionFillAmount() {
        const input = await waitForElement('#value', 5000);
        if (!input) return;
        setNativeValue(input, CONFIG.AMOUNT);
        await sleep(1000);
        const continueBtn = document.querySelector('button[type="submit"]:not([disabled])');
        if (continueBtn) { continueBtn.click(); await sleep(2000); }
    }

    async function actionConfirm() {
        const btn = await waitForElement('#confirmSendButton', 5000);
        if (btn) { btn.click(); await sleep(2000); }
    }

    async function actionDashboard() {
        const s = getState();
        if (s.mode !== MODE.PHASE_2_TRANSFER_TASK) {
             window.location.href = 'https://cantonloop.com/offers';
             return;
        }
        const listWrapper = await waitForElement('._listWrapper_r9kp1_16', 15000);
        if (!listWrapper) { location.reload(); return; }
        const btns = Array.from(document.querySelectorAll('button._wrapper_1og66_9'));
        const cbtcBtn = btns.find(b => b.innerText.includes('CBTC'));
        if (cbtcBtn) { cbtcBtn.click(); await sleep(2000); }
        else { window.location.href = 'https://cantonloop.com/asset/CBTC'; }
    }

    // ==========================================
    // 5. ä¸»å¾ªç¯ & UI
    // ==========================================
    function createDashboard() {
        if (document.getElementById('canton-bot-dashboard')) return;
        const div = document.createElement('div');
        div.id = 'canton-bot-dashboard';
        div.innerHTML = `
            <div style="border-bottom:1px solid #555; padding-bottom:5px; margin-bottom:5px; font-weight:bold;">ğŸ¤– Canton Bot V3.5</div>
            <div>çŠ¶æ€: <span id="bot-status">--</span></div>
            <div>é˜¶æ®µ: <span id="bot-mode" style="color:yellow">--</span></div>
            <div>è¿›åº¦: <span id="bot-target-info" style="color:#00e5ff">--</span></div>
            <div style="font-size:10px; margin-top:5px; color:#ddd;">åŠ¨ä½œ: <span id="bot-action">...</span></div>
            <div style="font-size:10px; color:#888; margin-top:5px; border-top:1px solid #444; padding-top:2px;">Win: Alt+S | Mac: Opt+S</div>
        `;
        document.body.appendChild(div);
    }

    function updateDashboardWithText(text) {
        const actEl = document.getElementById('bot-action');
        if(actEl) actEl.innerText = text;
    }

    function updateDashboard() {
        const s = getState();
        const stEl = document.getElementById('bot-status');
        const mdEl = document.getElementById('bot-mode');
        const infoEl = document.getElementById('bot-target-info');
        const actEl = document.getElementById('bot-action');
        
        if (stEl) {
            stEl.innerText = s.mode !== MODE.STOPPED ? "è¿è¡Œä¸­" : "å·²åœæ­¢";
            stEl.style.color = s.mode !== MODE.STOPPED ? "#4CAF50" : "#F44336";
        }
        if (mdEl) {
            const map = {
                'PHASE_1_CLEAR_OFFERS': '1.åˆå§‹æ¸…Offers',
                'PHASE_2_TRANSFER_TASK': '2.è½¬è´¦ä»»åŠ¡',
                'PHASE_3_MONITOR': '3.ç›‘æ§æŒ‚æœº',
                'STOPPED': 'åœæ­¢'
            };
            mdEl.innerText = map[s.mode] || s.mode;
        }
        if (infoEl) {
            if (s.mode === MODE.PHASE_2_TRANSFER_TASK) {
                infoEl.innerText = `${s.currentTargetIndex} / 10`;
            } else if (s.mode === MODE.PHASE_1_CLEAR_OFFERS) {
                 infoEl.innerText = `è¿ç»­æ¥æ”¶: ${s.consecutiveOffers || 0}`;
            } else if (s.mode === MODE.PHASE_3_MONITOR) {
                infoEl.innerText = "å®Œæˆ";
            } else {
                infoEl.innerText = "--";
            }
        }
        if (actEl) actEl.innerText = s.currentAction;
    }

    GM_addStyle(`
        #canton-bot-dashboard {
            position: fixed; top: 10px; left: 10px; z-index: 999999;
            background: rgba(0,0,0,0.85); color: white; padding: 12px;
            border-radius: 8px; font-family: monospace; font-size: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); min-width: 150px;
            backdrop-filter: blur(4px); user-select: none; pointer-events: none;
        }
    `);

    async function mainLoop() {
        const state = getState();
        if (state.mode === MODE.STOPPED) return;

        const page = identifyPage();
        const isProcessPage = ['PAGE_PASSWORD', 'PAGE_CONFIRM', 'PAGE_FILL_AMOUNT', 'PAGE_FILL_ADDRESS'].includes(page);

        // å†·å´/å€’è®¡æ—¶
        if (Date.now() < state.nextRunTime && !isProcessPage) {
            const wait = Math.ceil((state.nextRunTime - Date.now()) / 1000);
            updateDashboardWithText(`ç­‰å¾…: ${wait}s`);
            
            if (wait <= 0) {
                if (state.mode === MODE.PHASE_3_MONITOR) {
                    location.reload();
                    return;
                }
            } else {
                if (state.mode === MODE.PHASE_3_MONITOR && !window.location.href.includes('/offers')) {
                    window.location.href = 'https://cantonloop.com/offers';
                }
                return;
            }
        }

        // æ¨¡å¼çº é”™
        if (state.mode === MODE.PHASE_2_TRANSFER_TASK && page === 'PAGE_OFFERS') {
            await actionCheckOffers();
            return;
        }

        // å¯¼èˆªæ§åˆ¶
        if (state.mode === MODE.PHASE_1_CLEAR_OFFERS || state.mode === MODE.PHASE_3_MONITOR) {
            if (page === 'PAGE_PASSWORD') { /* continue */ }
            else if (page === 'PAGE_OFFERS') { /* continue */ }
            else if (!window.location.href.includes('/offers')) {
                updateDashboardWithText("å» Offers...");
                window.location.href = 'https://cantonloop.com/offers';
                return;
            }
        }
        
        if (state.mode === MODE.PHASE_2_TRANSFER_TASK) {
            if (page !== 'PAGE_ASSET_MAIN' && !isProcessPage && !window.location.href.includes('asset/CBTC')) {
                 // handled by switch
            }
        }

        if (state.currentAction !== page) setState({ currentAction: page });

        switch (page) {
            case 'PAGE_PASSWORD': await actionPassword(); break;
            case 'PAGE_CONFIRM': await actionConfirm(); break;
            case 'PAGE_FILL_AMOUNT': await actionFillAmount(); break;
            case 'PAGE_FILL_ADDRESS': await actionFillAddress(); break;
            case 'PAGE_ASSET_MAIN': await actionAssetMain(); break;
            case 'PAGE_DASHBOARD': await actionDashboard(); break;
            case 'PAGE_OFFERS': await actionCheckOffers(); break;
            case 'PAGE_UNKNOWN':
                if (window.location.href.includes('dashboard') && !window.location.href.includes('asset')) {
                   await actionDashboard();
                }
                break;
        }
    }

    window.addEventListener('keydown', (e) => {
        if (e.altKey && e.code === 'KeyS') {
            e.preventDefault(); e.stopPropagation();
            const s = getState();
            
            if (s.mode !== MODE.STOPPED) {
                setState({ mode: MODE.STOPPED, currentAction: 'å·²åœæ­¢' });
            } else {
                const libLen = CONFIG.ADDRESS_LIBRARY.length;
                if (libLen === 0) {
                    alert("è¯·é…ç½®åœ°å€åº“");
                    return;
                }

                const input = prompt(`ã€å¯åŠ¨é…ç½®ã€‘åœ°å€åº“å…± ${libLen} ä¸ªã€‚\nè¯·è¾“å…¥å½“å‰é’±åŒ…åºå· (1 - ${libLen}):`);
                const idx = parseInt(input);
                
                if (isNaN(idx) || idx < 1 || idx > libLen) {
                    alert("åºå·æ— æ•ˆ");
                    return;
                }

                const myIndex0 = idx - 1; 
                const targetList = calculateTargetList(myIndex0, CONFIG.ADDRESS_LIBRARY);
                
                alert(`å¯åŠ¨ï¼\né˜¶æ®µ1: æ¸…ç©ºå¾…ç¡®è®¤ (å¤±è´¥æ£€æµ‹+è‡ªåŠ¨åˆ·æ–°)\né˜¶æ®µ2: è½¬è´¦ç»™åç»­ 10 ä¸ªåœ°å€\né˜¶æ®µ3: ç›‘æ§æ¨¡å¼`);

                setState({ 
                    mode: MODE.PHASE_1_CLEAR_OFFERS, 
                    targetList: targetList,
                    currentTargetIndex: 0,
                    successCount: 0, 
                    consecutiveOffers: 0,
                    nextRunTime: 0
                });
                location.reload();
            }
        }
    }, true);

    function init() {
        createDashboard();
        updateDashboard();
        setInterval(mainLoop, 1500);
    }

    if (document.readyState === 'complete') init();
    else window.addEventListener('load', init);

})();
